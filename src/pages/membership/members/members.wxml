<loading isLoading="{{ isLoading }}" />

<view class="container" wx:if="{{!isLoading}}">
	<!-- 用户信息及开通会员 -->
	<view class="member-header {{ config.store_card_enable ? '' : 'noMemberCard' }}">
		<view class="member-top {{ config.store_card_enable ? '' : 'noCard' }}">
			<button class="head-button" bindgetuserinfo="bindGetUserInfo" open-type="getUserInfo">
				<image src="{{ user.avatarurl ? user.avatarurl : '/icons/unlogin.png' }}" mode="aspectFit" class="avatar"></image>
			</button>
			<view class="member-text">
				<view class="member-user-wrap">
					<view class="member-user">{{ !user.nickname ? '点击头像登录' : user.nickname }}</view>
					<!-- 会员 -->
					<view class="member-level" wx:if="{{ user.membership && user.membership.is_member }}">{{ user.membership.level_name || '暂无数据'}}</view>
				</view>
				<!-- 会员 -->
				<navigator url="/pages/membership/integralList/integralList" class="integral-text" wx:if="{{ user.membership && user.membership.is_member }}">
					<view class="cart-text">会员积分：</view>
					<view class="cart-price">{{ user.membership.exp || '0' }}分</view>
					<image mode="aspectFit" class="cart-arrow" src="/icons/member/score-arrow.svg"></image>
				</navigator>
				<!-- 非会员 -->
				<view class="no-member-level" wx:if="{{ user.membership && !user.membership.is_member }}">普通用户</view>
			</view>
			<!-- 非会员 -->
			<view class="head-openVip"  wx:if="{{ user.membership && !user.membership.is_member }}">
				<!-- 已开通储值卡功能 -->
				<block wx:if="{{ config.store_card_enable }}">
					<view class="openVip-btn" bindtap="openCommonRechargeModal">立即开通会员</view>
					<view class="openVip-tip">{{ ruleData.word }}</view>
				</block>
				<!-- 没开储值卡功能 -->
				<block wx:if="{{ !config.store_card_enable }}">
					<view class="openVip-btn" bindtap="buyMember">立即开通会员</view>
					<view class="openVip-tip">开通会员仅需{{ globalData.CURRENCY[globalData.currency] }}{{ config.membership.rules.payment }}</view>
				</block>
			</view>
			
		</view>
		<!-- 会员 -->
		<block wx:if="{{ user.membership && user.membership.is_member }}">
			<!-- 开通储值卡功能 -->
			<view class="member-bottom" wx:if="{{ config.store_card_enable }}">
				<navigator url="/pages/membership/consumptionCenter/consumptionCenter" class="member-integral-text">
					<view class="cart-price">{{ user.store_card.cash_balance }} 元</view>
					<view class="cart-text">储蓄余额</view>
				</navigator>
				<navigator url="/pages/membership/consumptionCenter/consumptionCenter" class="member-integral-text">
					<view class="cart-price">{{ user.store_card.gift_balance }} 元</view>
					<view class="cart-text">赠送余额</view>
				</navigator>
				<view class="recharge" bindtap="openRechargeModal">
					<text>充值</text>
				</view>
			</view>
		</block>
	</view>

	<view class="member-rights">
		<!-- 会员优惠券 -->
		<view class="member-coupon">
			<view class="rights-item-title">
				<text>会员优惠券</text>
			</view>
			<view class="coupon-list">
				<view class="coupon"
				wx:for="{{ memberCouponList }}"
				wx:key="id"
				bindtap="onCouponClick"
				data-id="{{ item.id }}"
				data-status="{{ item.status }}"
				data-title="{{ item.title }}"
				data-index="{{ index }}"
				wx:if="{{ index < 2 }}"
				>
					<form bindsubmit="submitFormId" report-submit="true">
						<button class="couponInfoList" formType="submit" hover-class="none">
							<view class="couponInfo">
								<view class="reduce">
									<text wx:if="{{ item.type == 1 }}">{{ globalData.CURRENCY[globalData.currency] }}</text>
									<text class="reduceCost">{{ item.type == 1 ? item.reduce_cost : (100 - item.discount) / 10 }}</text>
									<text wx:if="{{ item.type == 2 }}">折</text>
								</view>
								<view class="title">满{{ item.least_cost }}元使用</view>
							</view>
							<view class="couponBtn">
								<text class="couponUnuse" wx:if="{{ item.status == 2 && item.stock_qty }}" >立即领取</text>
								<text class="couponUnuse" wx:if="{{ item.status == 4 }}" >立即使用</text>
								<text class="couponUsed" wx:if="{{ item.status == 5 }}" >已使用</text>
								<text class="couponUsed" wx:if="{{ item.status == 2 && !item.stock_qty }}" >已抢光</text>
								<text class="couponUsed" wx:if="{{ item.status == 3 }}" >已过期</text>
								<image class="arrow" wx:if="{{ item.status == 2 && item.stock_qty || item.status == 4 }}" src="/icons/member/score-arrow.svg" mode="aspectFit"/>
							</view>
							<block>
								<!-- 待领取 -->
								<image class="bg" src="/icons/member/vipCouponHas-small.svg" wx:if="{{ item.status == 2 && item.stock_qty }}" /> 
								<!-- 已领取 -->
								<image class="bg" src="/icons/member/vipCouponHad-small.svg" wx:if="{{ item.status == 4 }}" /> 
								<!-- 已失效 -->
								<image class="bg" src="/icons/member/vipCouponEnd-small.svg" wx:if="{{ (item.status == 2 && !item.stock_qty) || item.status == 3 || item.status == 5 }}" /> 
							</block>
						</button>
					</form>
				</view>
				<navigator class="moreCoupon" url="/pages/couponList/couponList" wx:if="{{ memberCouponList.length > 1 }}">
					<view class="moreBtn">查看更多</view>
				</navigator>
          </view>
		</view>
		
		<!-- 会员专属商品 -->
		<view class="member-goods-banner">
			<view class="rights-item-title">
				<text>会员专享商品</text>
			</view>
			<image src="/icons/member/vipGoodsOwnBanner.svg" mode="aspectFill" bindtap="go" data-url="/pages/productList/productList?memberExclusive='{{true}}'"></image>
		</view>
	</view>

	<!-- 我的积分、积分规则、联系客服 -->
	<view class="jump-list">
		<view class="jump-item jump-score" bindtap="go" data-url="/pages/membership/integralList/integralList" wx:if="{{ user.membership && user.membership.is_member }}">
			<image mode="aspectFit" class="jump-icon" src="/icons/member/myScore.svg"></image>
			<text>我的积分</text>
			<image mode="aspectFit" class="jump-arrow" src="/icons/member/right.png"></image>
		</view>
		<view class="jump-item jump-rule" bindtap="go" data-url="/pages/membership/memberRule/memberRule">
			<image mode="aspectFit" class="jump-icon" src="/icons/member/memberRule.svg"></image>
			<text>积分规则</text>
			<image mode="aspectFit" class="jump-arrow" src="/icons/member/right.png"></image>
		</view>
		<view class="jump-item jump-contact">
			<button class="member-concat" data-name="contact" open-type="contact" session-from='{"nickName":"{{ user.nickname }}", "avatarUrl":"{{ user.avatarurl }}", "from":"me"}'>
				<image class="jump-icon member-itemIcon" mode="aspectFit" src="/icons/member/customerService.svg" />
				<view class="member-itemTitle">联系客服</view>
				<image mode="aspectFit" class="jump-arrow" src="/icons/member/right.png"></image>
			</button>
		</view>
	</view>

	<!-- 非会员充值弹窗 -->
	<popup rechargeModal="{{ commonRechargeModal }}" rechargeArray="{{ rechargeArray }}" user="{{ user }}" config="{{ config }}"></popup>

	<!-- 会员充值弹窗 -->
	<popup rechargeModal="{{ rechargeModal }}" rechargeArray="{{ rechargeArray }}" user="{{ user }}" onsetConsumptionList="setConsumptionList"></popup>
</view>

<console page="会员中心" />